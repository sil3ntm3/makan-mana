<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Makan Mana</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0b0b;color:#f3f3f3}
    .wrap{max-width:900px;margin:32px auto;padding:16px}
    .panel{background:#151515;border:1px solid #262626;border-radius:16px;padding:16px;margin-bottom:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    label{font-size:12px;color:#9aa0a6;display:flex;flex-direction:column;gap:6px}
    select,input,button{background:#111;color:#f3f3f3;border:1px solid #262626;border-radius:999px;padding:10px}
    button.primary{background:#f3f3f3;color:#111;border:0}
    #map{height:420px;border-radius:12px;border:1px solid #262626}
    .result{margin-top:12px;padding:12px;border:1px solid #262626;border-radius:12px;background:#111}
    .badge{font-size:11px;color:#e2e8f0;background:#1f2937;border:1px solid #334155;padding:4px 8px;border-radius:999px;margin-right:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Makan Mana</h1>
  <div class="panel">
    <div class="row">
      <label>Radius
        <select id="radius">
          <option value="1000" selected>1 km</option>
          <option value="2000">2 km</option>
          <option value="3000">3 km</option>
        </select>
      </label>
      <label>Type
        <select id="type">
          <option value="restaurant" selected>Restaurant</option>
          <option value="cafe">Cafe</option>
          <option value="fast_food">Fast food</option>
        </select>
      </label>
      <label>Keyword
        <input id="keyword" placeholder="optional"/>
      </label>
      <label>Open now
        <select id="openNow">
          <option value="">Any</option>
          <option value="1">Yes</option>
        </select>
      </label>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnGo" class="primary">I’m Hungry</button>
      <button id="btnPin">Use Map Pin Instead</button>
    </div>
  </div>
  <div class="panel">
    <div id="map"></div>
    <div id="result" class="result"></div>
  </div>
</div>

<script>
let map = L.map('map', { zoomControl: true });
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
map.setView([3.1390, 101.6869], 12);

let userMarker, pickMarker, circle;
let usePin = false;

document.getElementById('btnPin').onclick = () => { 
  usePin = true; 
  alert('Pin mode ON. Move the map so the center is your location, then click “I’m Hungry”.'); 
};

async function getLocation(){
  if (usePin) {
    const c = map.getCenter();
    return { lat: c.lat, lng: c.lng, via: 'pin' };
  }
  return new Promise((resolve, reject)=>{
    if (!navigator.geolocation) return reject('Geolocation unsupported');
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude, via: 'gps' }),
      err => reject(err.message||'Permission/timeout'),
      { enableHighAccuracy: true, timeout: 15000 }
    );
  });
}

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

function buildOverpassQuery({lat,lng,radius,type,keyword}){
  const around = `around:${radius},${lat},${lng}`;
  const types = ['node','way','relation'];
  const amenity = { restaurant:'restaurant', cafe:'cafe', fast_food:'fast_food' }[type] || 'restaurant';
  const kw = keyword ? `[(name~\"${keyword}\",i)|(cuisine~\"${keyword}\",i)]` : '';
  return `
    [out:json][timeout:25];
    (
      ${types.map(t=>`${t}(${around})[amenity=${amenity}]${kw};`).join('\n')}
    );
    out center tags;
  `;
}

async function overpass(q){
  const urls = [
    'https://overpass-api.de/api/interpreter',
    'https://overpass.kumi.systems/api/interpreter',
    'https://z.overpass-api.de/api/interpreter'
  ];
  for (const u of urls){
    try {
      const resp = await fetch(u, { method:'POST', body:q, headers:{'Content-Type':'text/plain'} });
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      return await resp.json();
    } catch(e){
      console.warn('Overpass failed at', u, e);
    }
  }
  throw new Error('All Overpass endpoints failed');
}

async function run(){
  try{
    document.getElementById('result').textContent='';
    const radius = Number(document.getElementById('radius').value);
    const type = document.getElementById('type').value;
    const keyword = document.getElementById('keyword').value.trim();
    const openNow = document.getElementById('openNow').value === '1';

    const loc = await getLocation();
    if (!userMarker) userMarker = L.marker([loc.lat, loc.lng], { title:'You' }).addTo(map);
    userMarker.setLatLng([loc.lat, loc.lng]);
    map.setView([loc.lat, loc.lng], 15);
    if (circle) circle.remove();
    circle = L.circle([loc.lat, loc.lng], { radius, color:'#333' }).addTo(map);

    const q = buildOverpassQuery({lat:loc.lat, lng:loc.lng, radius, type, keyword});
    const data = await overpass(q);
    const list = (data.elements||[]).map(e => ({ id:e.id, lat:e.lat||e.center?.lat, lon:e.lon||e.center?.lon, tags:e.tags||{} })).filter(e=>e.lat && e.lon);
    if(!list.length){ document.getElementById('result').textContent='No places found.'; return; }

    const pick = list[Math.floor(Math.random()*list.length)];
    if (pickMarker) pickMarker.remove();
    pickMarker = L.marker([pick.lat, pick.lon], { title: pick.tags.name||'Pick' }).addTo(map);
    map.panTo([pick.lat, pick.lon]);
    document.getElementById('result').innerHTML = 
      '<div><span class="badge">Chosen</span> ' + (pick.tags.name||'(Unnamed)') + '</div>' +
      (pick.tags.cuisine?'<div>Cuisine: '+pick.tags.cuisine+'</div>':'') +
      (pick.tags['addr:street']?'<div>Street: '+pick.tags['addr:street']+'</div>':'');
  }catch(e){
    document.getElementById('result').innerHTML = '<div style="color:#ef4444">Error: '+(e.message||e)+'</div>';
  }
}

document.getElementById('btnGo').onclick = run;
</script>
</body>
</html>
