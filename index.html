<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Makan Mana?!</title>

  <!-- Leaflet (OSM maps) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Opening hours parser -->
  <script src="https://cdn.jsdelivr.net/npm/opening_hours@3.10.0/opening_hours.min.js"></script>

  <style>
    :root { 
      --bg:#F5DDC2; 
      --fg:#111; 
      --muted:#444; 
      --card:#fff; 
      --accent:#F45F67; 
      --border:#ccc; 
      --radius:16px;
      --pad:16px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);color:var(--fg);
      padding-left:max(var(--pad),env(safe-area-inset-left));
      padding-right:max(var(--pad),env(safe-area-inset-right));
    }
    .wrap{max-width:980px;margin:32px auto;padding-top:calc(var(--pad) + var(--safe-top));padding-bottom:calc(var(--pad) + var(--safe-bottom))}
    h1{margin:0 0 4px;font-size:clamp(24px,2.2vw,32px)}
    /* Force bigger heading on small screens */
@media (max-width: 600px) {
  h1 {
    font-size: 32px; /* you can try 34px or 36px if you want extra big */
  }
  p.small {
    font-size: 25px;
  }
}
    p.small{color:var(--muted);margin:4px 0 16px;font-size:clamp(12px,1.4vw,14px)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad)}
    .controls{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .row>label,.row>button{flex:1 1 160px}
    label{font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
    select,input{background:#fff;color:var(--fg);border:1px solid var(--border);border-radius:999px;padding:12px 14px;min-width:120px;font-size:14px}
    .hint{font-size:12px;color:var(--muted)}
    button{border:0;background:var(--accent);color:#fff;padding:14px 16px;border-radius:999px;cursor:pointer;font-weight:600}
    button.secondary{background:#fff;color:var(--fg);border:1px solid var(--border)}
    button.warn{background:#f59e0b;color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    #map{height:clamp(320px,60vh,520px);border-radius:12px;overflow:hidden;border:1px solid var(--border)}
    .result{margin-top:12px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .title{font-weight:700;font-size:clamp(16px,1.8vw,18px)}
    .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .badge{font-size:12px;color:#333;background:#eee;border:1px solid #ddd;padding:4px 8px;border-radius:999px}
    .links{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    a.btn{display:inline-block;padding:10px 12px;border-radius:999px;border:1px solid var(--border);background:var(--accent);color:#fff;flex:1 1 180px;text-align:center;text-decoration:none}
    .disclaimer{font-size:12px;color:var(--muted);margin-top:8px}
    footer{color:var(--muted);font-size:12px;margin-top:12px}
    .banner{margin:8px 0;padding:10px;border-radius:10px;border:1px solid var(--border)}
    .banner.error{background:#fdd;color:#600;border-color:#7f1d1d}
    .banner.info{background:#eef;color:#112;border-color:#1f2937}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Makan Mana?!</h1>
    <p class="small">Soalan paling susah sepanjang zaman. Jangan risau. Pilih kawasan dan tekan butang!.<br>Lokasi restoran anda akan dipilih secara random dan anda mesti makan di kedai tersebut!. Selamat menjamu selera.</p>

    <div id="banner" class="banner info" hidden></div>

    <div class="grid">
      <!-- Controls -->
      <div class="panel">
        <div class="controls">
          <div class="row">
            <label>Radius
              <select id="radius">
                <option value="800">0.8 km</option>
                <option value="1000" selected>1 km</option>
                <option value="2000">2 km</option>
                <option value="3000">3 km</option>
                <option value="5000">5 km</option>
              </select>
            </label>
            <label>Type
              <select id="type">
                <option value="restaurant" selected>Restaurant</option>
                <option value="fast_food">Fast food</option>
                <option value="cafe">Cafe</option>
                <option value="food_court">Food court</option>
              </select>
            </label>
          </div>
          <div class="row">
            <label>Keyword (halal, thai, nasi, burger...) 
              <input id="keyword" placeholder="optional" />
            </label>
            <label>Open now
              <select id="openNow">
                <option value="">Any</option>
                <option value="1" selected>Yes</option>
              </select>
            </label>
          </div>
          <div class="row">
            <button id="btnGo" type="button">I’m Hungry</button>
            <button id="btnReroll" type="button" class="secondary" disabled>Reroll (2)</button>
            <button id="btnLock" type="button" class="secondary" disabled>Lock It In</button>
          </div>
          <button id="btnUsePin" type="button" class="warn">Use Map Pin Instead of GPS</button>
          <div class="hint">If location permission fails, pan/zoom the map and click “Use Map Pin”.</div>
        </div>
      </div>

      <!-- Map + Result -->
      <div class="panel">
        <div id="result" class="result" hidden></div>
        <div id="map"></div>
        <div class="disclaimer">Data quality varies by area. Please verify halal status and opening hours.</div>
      </div>
    </div>

    <footer>Powered by OpenStreetMap. Made by Ts. Syazani Said.</footer>
  </div>

<script>
// --- Map Init ---
let map = L.map('map');
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'©OSM ©CARTO'}).addTo(map);
map.setView([3.139,101.6869],13);
let userMarker, pickMarker, circle;
let usePin=false;

// --- App State for buttons ---
let candidates = [];     // list of places from last search
let currentPick = null;  // selected place object
let lastLoc = null;      // {lat,lng} used for last query
let rerollsLeft = 2;

// --- Dom refs ---
const elResult  = document.getElementById('result');
const elBanner  = document.getElementById('banner');
const btnGo     = document.getElementById('btnGo');
const btnReroll = document.getElementById('btnReroll');
const btnLock   = document.getElementById('btnLock');

// --- Helpers ---
function setBanner(text, kind='info'){
  if(!text){ elBanner.hidden = true; return; }
  elBanner.textContent = text;
  elBanner.className = `banner ${kind}`;
  elBanner.hidden = false;
}

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000;const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

function buildOverpassQuery({lat,lng,radius,type,keyword}){
  const around=`around:${radius},${lat},${lng}`;
  const types=['node','way','relation'];
  const amenity={restaurant:'restaurant',cafe:'cafe',fast_food:'fast_food',food_court:'food_court'}[type]||'restaurant';
  const kw = keyword ? `[(name~\"${keyword}\",i)|(cuisine~\"${keyword}\",i)]` : '';
  return `[out:json][timeout:25];
(${types.map(t=>`${t}(${around})[amenity=${amenity}]${kw};`).join('\n')});
out center tags;`;
}

async function overpass(q){
  const urls=['https://overpass-api.de/api/interpreter','https://overpass.kumi.systems/api/interpreter','https://z.overpass-api.de/api/interpreter'];
  for(const u of urls){
    try{
      const r=await fetch(u,{method:'POST',body:q,headers:{'Content-Type':'text/plain'}});
      if(r.ok) return await r.json();
    }catch(e){ console.warn('Overpass fail',u,e); }
  }
  throw new Error('All Overpass endpoints failed');
}

// Render result card
function showResult(place,userLatLng){
  const el=elResult;
  if(!place){
    el.hidden=false;
    el.textContent='No places found.';
    return;
  }
  const dist=Math.round(place._distance);
  const name=place.tags.name||'(Unnamed place)';
  const cuisine=place.tags.cuisine?String(place.tags.cuisine).split(';').join(', '):'—';
  const isOpen=(function(tag){try{if(!tag)return null;return new opening_hours(tag).getState();}catch(e){return null;}})(place.tags['opening_hours']);
  const openStr=(isOpen===null)?'hours unknown':(isOpen?'open now':'closed now');
  const lat=place.lat,lon=place.lon;
  const waze=`https://waze.com/ul?ll=${lat}%2C${lon}&navigate=yes`;
  const apple=`https://maps.apple.com/?daddr=${lat},${lon}`;
  const gmaps=`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
  el.hidden=false;
  el.innerHTML = `
    <div class="title">${name}</div>
    <div class="badges">
      <span class="badge">cuisine: ${cuisine}</span>
      <span class="badge">${dist} m away</span>
      <span class="badge">${openStr}</span>
    </div>
    <div class="links">
      <a class="btn" href="${waze}" target="_blank">Open in Waze</a>
      <a class="btn" href="${apple}" target="_blank">Open in Apple Maps</a>
      <a class="btn" href="${gmaps}" target="_blank">Open in Google Maps</a>
    </div>`;
}

// pick + map UI
function setPick(pick){
  currentPick = pick;
  if(!pick || !lastLoc){ btnLock.disabled = true; return; }
  if(pickMarker) pickMarker.remove();
  pickMarker = L.marker([pick.lat, pick.lon], { title: pick.tags.name || 'Pick' }).addTo(map);
  map.panTo([pick.lat, pick.lon]);
  showResult(pick, lastLoc);
  btnLock.disabled = false;
  btnReroll.disabled = rerollsLeft <= 0 || (candidates.length <= 1);
  btnReroll.textContent = `Reroll (${rerollsLeft})`;
}

function randomDifferentPick(){
  if(!candidates.length) return null;
  if(candidates.length === 1) return candidates[0];
  let p;
  // try a few times to avoid same item
  for(let i=0;i<5;i++){
    p = candidates[Math.floor(Math.random()*candidates.length)];
    if(!currentPick || p.id !== currentPick.id) break;
  }
  return p;
}

// --- Main Run ---
async function run(){
  try{
    setBanner('');
    btnLock.disabled = true;
    btnReroll.disabled = true;

    const radius = Number(document.getElementById('radius').value);
    const type   = document.getElementById('type').value;
    const keyword= document.getElementById('keyword').value.trim();

    const loc = await getLocation();
    lastLoc = loc;

    if(!userMarker) userMarker = L.marker([loc.lat,loc.lng],{title:'You'}).addTo(map);
    userMarker.setLatLng([loc.lat,loc.lng]);
    map.setView([loc.lat,loc.lng],15);

    if(circle) circle.remove();
    circle = L.circle([loc.lat,loc.lng],{radius,color:'#333'}).addTo(map);

    const q = buildOverpassQuery({lat:loc.lat,lng:loc.lng,radius,type,keyword});
    const data = await overpass(q);

    candidates = (data.elements||[])
      .map(e=>({id:e.id,lat:e.lat||e.center?.lat,lon:e.lon||e.center?.lon,tags:e.tags||{}}))
      .filter(e=>e.lat&&e.lon);

    candidates.forEach(p=>p._distance=haversine(loc.lat,loc.lng,p.lat,p.lon));

    if(!candidates.length){
      showResult(null, loc);
      setBanner('No places found in that area with those filters.', 'error');
      return;
    }

    // reset rerolls each fresh search
    rerollsLeft = 2;
    const firstPick = randomDifferentPick();
    setPick(firstPick);
  }catch(e){
    elResult.hidden = false;
    elResult.innerHTML = '<div style="color:#c00">Error: '+(e.message||e)+'</div>';
  }
}

function getLocation(){
  if(usePin){
    const c=map.getCenter();
    return Promise.resolve({lat:c.lat,lng:c.lng});
  }
  return new Promise((res,rej)=>{
    if(!navigator.geolocation) return rej('Geolocation unsupported');
    navigator.geolocation.getCurrentPosition(
      p=>res({lat:p.coords.latitude,lng:p.coords.longitude}),
      e=>rej(e.message||'Permission/timeout'),
      {enableHighAccuracy:true,timeout:15000}
    );
  });
}

// --- Buttons ---
btnGo.addEventListener('click', run);

document.getElementById('btnUsePin').addEventListener('click', ()=>{
  usePin = true;
  alert('Pin mode ON. Move map, then press “I’m Hungry”.');
});

// NEW: Reroll + Lock handlers
btnReroll.addEventListener('click', (e)=>{
  e.preventDefault();
  if(rerollsLeft <= 0) return;
  const next = randomDifferentPick();
  if(next){
    rerollsLeft--;
    setPick(next);
  }
});

btnLock.addEventListener('click', (e)=>{
  e.preventDefault();
  if(!currentPick) return;
  // Save a simple history to localStorage (you can expand this later)
  const history = JSON.parse(localStorage.getItem('lockedChoices')||'[]');
  history.push({
    id: currentPick.id,
    name: currentPick.tags.name || '(Unnamed place)',
    lat: currentPick.lat,
    lon: currentPick.lon,
    at: new Date().toISOString()
  });
  localStorage.setItem('lockedChoices', JSON.stringify(history));
  setBanner('✅ Locked in! Selamat makan dan jangan tukar lokasi ya. 😋');
  btnLock.disabled = true;
  // optional: also disable reroll after lock
  btnReroll.disabled = true;
});
</script>
</body>
</html>
